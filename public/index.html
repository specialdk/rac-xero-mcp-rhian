<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAC Live Financial Dashboard - Xero & ApprovalMax Integration</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        line-height: 1.6;
        color: #333;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
        padding: 40px 0;
      }

      .header h1 {
        font-size: 3rem;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .header p {
        font-size: 1.3rem;
        opacity: 0.9;
      }

      .live-indicator {
        display: inline-flex;
        align-items: center;
        background: rgba(76, 175, 80, 0.2);
        padding: 8px 16px;
        border-radius: 20px;
        margin-top: 15px;
        font-size: 0.9rem;
      }

      .live-dot {
        width: 8px;
        height: 8px;
        background: #4caf50;
        border-radius: 50%;
        margin-right: 8px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .controls {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .controls h3 {
        color: #13547a;
        margin-bottom: 15px;
      }

      .subsidiary-selector {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .subsidiary-selector select {
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        background: white;
        cursor: pointer;
      }

      .view-toggle {
        display: flex;
        gap: 10px;
      }

      .toggle-btn {
        padding: 8px 16px;
        border: 2px solid #13547a;
        background: white;
        color: #13547a;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .toggle-btn.active {
        background: #13547a;
        color: white;
      }

      .connection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .entity-connection-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        border-left: 4px solid #e0e0e0;
        transition: all 0.3s ease;
      }

      .entity-connection-card.connected {
        border-left-color: #4caf50;
        background: #f1f8e9;
      }

      .entity-connection-card.disconnected {
        border-left-color: #ff9800;
        background: #fff3e0;
      }

      .entity-connection-card.xero {
        border-left-color: #13547a;
      }

      .entity-connection-card.approvalmax {
        border-left-color: #8e44ad;
      }

      .entity-name {
        font-weight: bold;
        color: #13547a;
        margin-bottom: 8px;
      }

      .provider-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: bold;
        margin-bottom: 8px;
      }

      .provider-badge.xero {
        background: #13547a;
        color: white;
      }

      .provider-badge.approvalmax {
        background: #8e44ad;
        color: white;
      }

      .connection-status {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      .status-indicator.connected {
        background: #4caf50;
      }

      .status-indicator.disconnected {
        background: #ff9800;
      }

      .connect-btn {
        background: #13547a;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.3s ease;
        margin-right: 5px;
      }

      .connect-btn:hover {
        background: #0f4059;
      }

      .connect-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .connect-btn.approvalmax {
        background: #8e44ad;
      }

      .connect-btn.approvalmax:hover {
        background: #7d3c98;
      }

      .connection-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .overlay-content {
        background: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 1000px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      .overlay-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
      }

      .close-btn {
        background: #ff5722;
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .close-btn:hover {
        background: #d84315;
      }

      .connection-status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
      }

      .connection-status-indicator.healthy {
        background: #e8f5e8;
        color: #2e7d32;
      }

      .connection-status-indicator.warning {
        background: #fff3e0;
        color: #f57c00;
      }

      .connection-status-indicator.error {
        background: #ffebee;
        color: #c62828;
      }

      .progress-bar {
        background: #e0e0e0;
        border-radius: 10px;
        height: 8px;
        margin: 15px 0;
        overflow: hidden;
      }

      .progress-fill {
        background: linear-gradient(45deg, #4caf50, #8bc34a);
        height: 100%;
        transition: width 0.3s ease;
      }

      .demo-grid {
        display: grid;
        grid-template-columns: 1fr 1fr; /* 2 equal columns */
        gap: 30px;
        margin-bottom: 40px;
      }

      .demo-card.financial-overview {
        grid-column: 1 / -1; /* Span full width */
      }

      .demo-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.3s ease;
      }

      .demo-card:hover {
        transform: translateY(-5px);
      }

      .card-header {
        background: linear-gradient(45deg, #13547a 0%, #80d0c7 100%);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .card-header.approvalmax {
        background: linear-gradient(45deg, #8e44ad 0%, #c39bd3 100%);
      }

      .card-header h3 {
        font-size: 1.5rem;
        margin-bottom: 5px;
      }

      .card-header p {
        opacity: 0.9;
        font-size: 0.9rem;
      }

      .card-content {
        padding: 25px;
      }

      .feature-list {
        list-style: none;
        margin-bottom: 20px;
      }

      .feature-list li {
        margin-bottom: 12px;
        padding-left: 25px;
        position: relative;
      }

      .feature-list li::before {
        content: "‚úì";
        position: absolute;
        left: 0;
        color: #4caf50;
        font-weight: bold;
        font-size: 1.2rem;
      }

      .dashboard-mockup {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 15px 0;
        border-left: 4px solid #13547a;
      }

      .dashboard-mockup.approvalmax {
        border-left-color: #8e44ad;
      }

      .metric-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }

      .metric-label {
        font-weight: 600;
        color: #666;
      }

      .metric-value {
        font-weight: bold;
        color: #13547a;
      }

      .metric-value.large {
        font-size: 1.2rem;
      }

      .metric-value.approvalmax {
        color: #8e44ad;
      }

      .chart-placeholder {
        height: 120px;
        background: linear-gradient(45deg, #e3f2fd 0%, #bbdefb 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 15px 0;
        color: #1976d2;
        font-weight: 600;
      }

      .alert-box {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 12px;
        margin: 10px 0;
        color: #856404;
      }

      .success-box {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 8px;
        padding: 12px;
        margin: 10px 0;
        color: #155724;
      }

      .info-box {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 8px;
        padding: 12px;
        margin: 10px 0;
        color: #0c5460;
      }

      .contacts-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin: 15px 0;
      }

      .contact-stat {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .contact-stat .number {
        font-size: 1.5rem;
        font-weight: bold;
        color: #13547a;
      }

      .contact-stat .label {
        font-size: 0.9rem;
        color: #666;
        margin-top: 5px;
      }

      .loading {
        color: #666;
        font-style: italic;
        text-align: center;
        padding: 20px;
      }

      .error {
        color: #dc3545;
        font-style: italic;
        text-align: center;
        padding: 20px;
      }

      .cta-section {
        background: white;
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        margin-top: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .cta-section h2 {
        color: #13547a;
        margin-bottom: 20px;
        font-size: 2rem;
      }

      .last-updated {
        font-size: 0.8rem;
        color: #888;
        text-align: center;
        margin-top: 15px;
        font-style: italic;
      }

      .system-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
      }

      .system-tab {
        padding: 10px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
      }

      .system-tab.active {
        color: #13547a;
        border-bottom-color: #13547a;
        font-weight: bold;
      }

      .system-tab.approvalmax.active {
        color: #8e44ad;
        border-bottom-color: #8e44ad;
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 2rem;
        }

        .demo-grid {
          grid-template-columns: 1fr;
        }

        .subsidiary-selector {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üè¢ RAC Financial Dashboard</h1>
        <p>Real-Time Xero & ApprovalMax Integration - Live Data</p>
        <div class="live-indicator">
          <div class="live-dot"></div>
          Connected to Xero & ApprovalMax ‚Ä¢ Live Data
        </div>
      </div>

      <!-- Connection Manager -->
      <div class="controls" id="connection-manager">
        <h3>üîó RAC Entity Connection Manager</h3>
        <div class="system-tabs">
          <button class="system-tab active" onclick="setSystemView('all')">
            All Systems
          </button>
          <button class="system-tab" onclick="setSystemView('xero')">
            Xero Only
          </button>
          <button
            class="system-tab approvalmax"
            onclick="setSystemView('approvalmax')"
          >
            ApprovalMax Only
          </button>
        </div>
        <div id="connection-status"></div>
      </div>

      <!-- Dashboard Controls -->
      <div class="controls" id="dashboard-controls" style="display: none">
        <h3>üìä Dashboard Controls</h3>
        <div class="subsidiary-selector">
          <label for="subsidiary-select"
            ><strong>Select RAC Entity:</strong></label
          >
          <select id="subsidiary-select">
            <option value="consolidated">
              üè¢ Consolidated View (All Entities)
            </option>
          </select>

          <div class="view-toggle">
            <button class="toggle-btn active" onclick="setView('overview')">
              Overview
            </button>
            <button class="toggle-btn" onclick="setView('detailed')">
              Detailed
            </button>
            <button class="toggle-btn" onclick="toggleConnectionManager()">
              Connection Status
            </button>
          </div>
        </div>
      </div>

      <!-- Connection Manager Overlay -->
      <div
        id="connection-overlay"
        class="connection-overlay"
        style="display: none"
      >
        <div class="overlay-content">
          <div class="overlay-header">
            <h3>üîó RAC Entity Connection Manager</h3>
            <button class="close-btn" onclick="closeConnectionManager()">
              ‚úï
            </button>
          </div>
          <div class="system-tabs">
            <button class="system-tab active" onclick="setSystemView('all')">
              All Systems
            </button>
            <button class="system-tab" onclick="setSystemView('xero')">
              Xero Only
            </button>
            <button
              class="system-tab approvalmax"
              onclick="setSystemView('approvalmax')"
            >
              ApprovalMax Only
            </button>
          </div>
          <div id="overlay-connection-status"></div>
        </div>
      </div>

      <div class="demo-grid" id="dashboard-content">
        <!-- Content will be loaded dynamically -->
        <div class="loading">Loading live RAC financial data...</div>
      </div>

      <div class="cta-section">
        <h2>üöÄ RAC Integrated Financial Dashboard!</h2>
        <p>
          Your Xero and ApprovalMax integrations are now live and pulling real
          financial data. All figures are updated in real-time from your RAC
          systems.
        </p>

        <div class="success-box" style="margin: 20px 0">
          <strong>Integration Achievements:</strong><br />
          ‚úÖ Xero OAuth authentication successful<br />
          ‚úÖ ApprovalMax OAuth authentication successful<br />
          ‚úÖ Live data connections established<br />
          ‚úÖ Financial & procurement metrics streaming in real-time<br />
          ‚úÖ Multi-entity support active<br />
          ‚úÖ Unified dashboard operational
        </div>

        <p style="margin-top: 20px; color: #666">
          Ready to extend this integration to your other RAC systems? Your
          Grants App, Inventory System, and Intranet are all ready to connect to
          this centralized financial intelligence platform.
        </p>
      </div>

      <div class="last-updated">
        Last updated: <span id="timestamp"></span> ‚Ä¢ Data sources: Live RAC Xero
        & ApprovalMax Accounts
      </div>
    </div>

    <script>
      let currentView = "overview";
      let currentSystemView = "all";
      let dashboardData = {};

      // Define all RAC entities
      const racEntities = [
        "Rirratjingu Aboriginal Corporation 8538",
        "Rirratjingu Mining Pty Ltd 7168",
        "Rirratjingu Property Management & Maintenance Services Pty Ltd",
        "Rirratjingu Enterprises Pty Ltd",
        "Rirratjingu Invest P/ L ATF Miliditjpi Trust",
        "Ngarrkuwuy Developments Pty Ltd",
        "Marrin Square Developments Pty Ltd",
      ];

      // Set system view (all, xero, approvalmax)
      function setSystemView(view) {
        currentSystemView = view;

        // Update tab states
        document.querySelectorAll(".system-tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.classList.add("active");

        // Reload connection status with filter
        loadConnectionStatus();
      }

      // Show connection manager
      function showConnectionManager(connectionData) {
        const connectionStatus = document.getElementById("connection-status");

        // Create comprehensive entity list for both systems
        const entityConnections = createEntityConnectionList(connectionData);

        // Filter based on current system view
        let filteredConnections = entityConnections;
        if (currentSystemView === "xero") {
          filteredConnections = entityConnections.filter(
            (conn) => conn.provider === "xero"
          );
        } else if (currentSystemView === "approvalmax") {
          filteredConnections = entityConnections.filter(
            (conn) => conn.provider === "approvalmax"
          );
        }

        const connectedCount = filteredConnections.filter(
          (conn) => conn.connected
        ).length;
        const totalCount = filteredConnections.length;
        const progressPercent =
          totalCount > 0 ? (connectedCount / totalCount) * 100 : 0;

        connectionStatus.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span><strong>Connection Progress:</strong></span>
                        <span><strong>${connectedCount} of ${totalCount} connections active</strong></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                </div>
                
                <div class="connection-grid">
                    ${filteredConnections
                      .map((conn) => {
                        return `
                            <div class="entity-connection-card ${
                              conn.connected ? "connected" : "disconnected"
                            } ${conn.provider}">
                                <div class="provider-badge ${
                                  conn.provider
                                }">${conn.provider.toUpperCase()}</div>
                                <div class="entity-name">${
                                  conn.tenantName
                                }</div>
                                <div class="connection-status">
                                    <div class="status-indicator ${
                                      conn.connected
                                        ? "connected"
                                        : "disconnected"
                                    }"></div>
                                    <span>${
                                      conn.connected
                                        ? "Connected & Active"
                                        : "Not Connected"
                                    }</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin: 5px 0;">
                                    ${
                                      conn.provider === "approvalmax" &&
                                      conn.organizationCount !== undefined
                                        ? `Organizations: ${conn.organizationCount} connected`
                                        : `Last seen: ${
                                            conn.lastSeen || "Never"
                                          }`
                                    }
                                </div>
                                ${
                                  !conn.connected
                                    ? `
                                    <button class="connect-btn ${
                                      conn.provider
                                    }" onclick="connectEntity('${
                                        conn.tenantName
                                      }', '${conn.provider}')">
                                        Connect ${
                                          conn.provider === "xero"
                                            ? "Xero"
                                            : "ApprovalMax"
                                        }
                                    </button>
                                `
                                    : `
                                    <div style="color: #4CAF50; font-size: 0.9rem; margin-top: 10px;">
                                        ‚úÖ Live data connection active
                                    </div>
                                    <button class="connect-btn ${conn.provider}" onclick="connectEntity('${conn.tenantName}', '${conn.provider}')" style="font-size: 0.8rem; padding: 6px 12px; margin-top: 5px;">
                                        Reconnect
                                    </button>
                                `
                                }
                            </div>
                        `;
                      })
                      .join("")}
                </div>
                
                ${
                  connectedCount > 0
                    ? `
                    <div class="success-box" style="margin-top: 20px;">
                        üéâ <strong>${connectedCount} connections active!</strong> Your dashboard is receiving live data.
                        <button class="connect-btn" onclick="showDashboard()" style="margin-left: 15px;">
                            ${
                              connectedCount === totalCount
                                ? "Launch Full Dashboard"
                                : "View Partial Dashboard"
                            }
                        </button>
                    </div>
                `
                    : `
                    <div class="info-box" style="margin-top: 20px;">
                        üí° <strong>Connect your systems:</strong> Set up Xero and ApprovalMax connections to enable consolidated financial reporting.
                    </div>
                `
                }
            `;
      }

      // Create comprehensive entity connection list for both systems
      function createEntityConnectionList(connectionData) {
        const entityConnections = [];

        // Add individual Xero connection entries for each RAC entity
        racEntities.forEach((entityName) => {
          const xeroConnection = connectionData.find(
            (conn) => conn.provider === "xero" && conn.tenantName === entityName
          );

          entityConnections.push({
            tenantId: xeroConnection ? xeroConnection.tenantId : null,
            tenantName: entityName,
            provider: "xero",
            connected: xeroConnection ? xeroConnection.connected : false,
            lastSeen: xeroConnection ? xeroConnection.lastSeen : null,
            error: xeroConnection ? xeroConnection.error : null,
          });
        });

        // Add single ApprovalMax connection entry for all organizations
        const approvalMaxConnections = connectionData.filter(
          (conn) => conn.provider === "approvalmax"
        );
        const hasApprovalMaxConnection = approvalMaxConnections.length > 0;
        const connectedOrgsCount = approvalMaxConnections.filter(
          (conn) => conn.connected
        ).length;

        entityConnections.push({
          tenantId: hasApprovalMaxConnection ? "approvalmax-integration" : null,
          tenantName: "RAC ApprovalMax Integration",
          provider: "approvalmax",
          connected: connectedOrgsCount > 0,
          lastSeen: hasApprovalMaxConnection
            ? approvalMaxConnections[0].lastSeen
            : null,
          error: hasApprovalMaxConnection
            ? approvalMaxConnections[0].error
            : null,
          organizationCount: connectedOrgsCount,
          totalOrganizations: approvalMaxConnections.length,
        });

        return entityConnections;
      }

      // Connect to specific entity
      function connectEntity(entityName, provider) {
        localStorage.setItem("connecting_entity", entityName);
        localStorage.setItem("connecting_provider", provider);

        if (provider === "approvalmax") {
          window.location.href = "/auth?provider=approvalmax";
        } else {
          window.location.href = "/auth";
        }
      }

      // Toggle connection manager overlay
      function toggleConnectionManager() {
        document.getElementById("connection-overlay").style.display = "flex";
        loadConnectionStatus();
      }

      // Close connection manager overlay
      function closeConnectionManager() {
        document.getElementById("connection-overlay").style.display = "none";
      }

      // Load connection status
      async function loadConnectionStatus() {
        try {
          const response = await fetch("/api/connection-status");
          const connectionStatus = await response.json();

          if (
            document.getElementById("connection-overlay").style.display ===
            "flex"
          ) {
            showOverlayConnectionManager(connectionStatus);
          } else {
            showConnectionManager(connectionStatus);
          }
        } catch (error) {
          console.error("Error loading connection status:", error);
          const targetElement =
            document.getElementById("connection-overlay").style.display ===
            "flex"
              ? document.getElementById("overlay-connection-status")
              : document.getElementById("connection-status");

          targetElement.innerHTML = `
                    <div class="error">‚ùå Failed to load connection status</div>
                `;
        }
      }

      // Show connection manager in overlay
      function showOverlayConnectionManager(connectionStatusArray) {
        const connectionStatus = document.getElementById(
          "overlay-connection-status"
        );

        // Create comprehensive entity list for both systems
        const entityConnections = createEntityConnectionList(
          connectionStatusArray
        );

        // Filter based on current system view
        let filteredConnections = entityConnections;
        if (currentSystemView === "xero") {
          filteredConnections = entityConnections.filter(
            (conn) => conn.provider === "xero"
          );
        } else if (currentSystemView === "approvalmax") {
          filteredConnections = entityConnections.filter(
            (conn) => conn.provider === "approvalmax"
          );
        }

        const connectedCount = filteredConnections.filter(
          (conn) => conn.connected
        ).length;
        const totalCount = filteredConnections.length;
        const progressPercent =
          totalCount > 0 ? (connectedCount / totalCount) * 100 : 0;

        const healthStatus = connectedCount > 0 ? "healthy" : "error";
        const healthText =
          connectedCount > 0 ? "Connections active" : "No connections";

        connectionStatus.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span><strong>RAC System Connections:</strong></span>
                        <div class="connection-status-indicator ${healthStatus}">
                            <div class="status-indicator ${healthStatus}"></div>
                            ${healthText}
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span><strong>Connection Progress:</strong></span>
                        <span><strong>${connectedCount} of ${totalCount} connections active</strong></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                </div>
                
                <div class="connection-grid">
                    ${filteredConnections
                      .map((conn) => {
                        const lastSeen = conn.lastSeen
                          ? new Date(conn.lastSeen).toLocaleString()
                          : "Never";

                        return `
                            <div class="entity-connection-card ${
                              conn.connected ? "connected" : "disconnected"
                            } ${conn.provider}">
                                <div class="provider-badge ${
                                  conn.provider
                                }">${conn.provider.toUpperCase()}</div>
                                <div class="entity-name">${
                                  conn.tenantName
                                }</div>
                                <div class="connection-status">
                                    <div class="status-indicator ${
                                      conn.connected
                                        ? "connected"
                                        : "disconnected"
                                    }"></div>
                                    <span>${
                                      conn.connected
                                        ? "Connected & Active"
                                        : "Not Connected"
                                    }</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin: 5px 0;">
                                    ${
                                      conn.provider === "approvalmax" &&
                                      conn.organizationCount !== undefined
                                        ? `Organizations: ${conn.organizationCount} connected`
                                        : `Last seen: ${lastSeen}`
                                    }
                                </div>
                                ${
                                  !conn.connected
                                    ? `
                                    <button class="connect-btn ${
                                      conn.provider
                                    }" onclick="connectEntity('${
                                        conn.tenantName
                                      }', '${conn.provider}')">
                                        Connect ${
                                          conn.provider === "xero"
                                            ? "Xero"
                                            : "ApprovalMax"
                                        }
                                    </button>
                                `
                                    : `
                                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                                        <button class="connect-btn ${conn.provider}" onclick="testConnection('${conn.tenantId}', '${conn.provider}')" style="font-size: 0.8rem; padding: 6px 12px;">
                                            Test Connection
                                        </button>
                                        <button class="connect-btn ${conn.provider}" onclick="connectEntity('${conn.tenantName}', '${conn.provider}')" style="opacity: 0.7; font-size: 0.8rem; padding: 6px 12px;">
                                            Reconnect
                                        </button>
                                    </div>
                                `
                                }
                            </div>
                        `;
                      })
                      .join("")}
                </div>
            `;
      }

      // Test connection for specific entity
      async function testConnection(tenantId, provider) {
        try {
          let response;
          if (provider === "xero") {
            response = await fetch(`/api/cash-position/${tenantId}`);
          } else if (provider === "approvalmax") {
            response = await fetch(
              `/api/approvalmax/approval-summary/${tenantId}`
            );
          }

          if (response.ok) {
            alert(
              `‚úÖ ${provider.toUpperCase()} connection is healthy and returning data`
            );
          } else {
            alert(
              `‚ö†Ô∏è ${provider.toUpperCase()} connection may have issues (${
                response.status
              })`
            );
          }
        } catch (error) {
          alert(
            `‚ùå ${provider.toUpperCase()} connection test failed: ${
              error.message
            }`
          );
        }
      }

      // Load available tenants and show appropriate interface
      async function loadTenants() {
        try {
          const response = await fetch("/api/connection-status");
          const connectionStatus = await response.json();

          // Show connection manager with all systems
          showConnectionManager(connectionStatus);

          // Populate dashboard selector with connected entities
          const connectedEntities = connectionStatus.filter(
            (entity) => entity.connected
          );
          if (connectedEntities.length > 0) {
            const select = document.getElementById("subsidiary-select");

            const consolidatedOption = select.querySelector(
              'option[value="consolidated"]'
            );
            select.innerHTML = "";
            select.appendChild(consolidatedOption);

            connectedEntities.forEach((entity) => {
              const option = document.createElement("option");
              option.value = entity.tenantId;
              option.textContent = `üè¢ ${
                entity.tenantName
              } (${entity.provider.toUpperCase()})`;
              select.appendChild(option);
            });
          }

          // Auto-launch dashboard if we have connections
          if (connectedEntities.length > 0) {
            setTimeout(() => showDashboard(), 2000);
          }
        } catch (error) {
          console.error("Error loading connection status:", error);
          document.getElementById("connection-status").innerHTML = `
                    <div class="error">‚ùå Failed to load connection status. 
                    <button class="connect-btn" onclick="window.location.href='/auth'">Connect to Xero</button>
                    <button class="connect-btn approvalmax" onclick="window.location.href='/auth?provider=approvalmax'">Connect to ApprovalMax</button></div>
                `;
        }
      }

      // Load dashboard data based on selected view
      async function loadDashboardData() {
        const selectedTenant =
          document.getElementById("subsidiary-select").value;

        try {
          if (selectedTenant === "consolidated") {
            await loadTrialBalanceData(); // ‚Üê CHANGE: Load trial balance instead of old consolidated data
          } else {
            await loadIndividualTenantData(selectedTenant);
          }
        } catch (error) {
          console.error("Error loading dashboard data:", error);
          showError("Failed to load financial data");
        }
      }

      // Load individual tenant data
      async function loadIndividualTenantData(tenantId) {
        try {
          // Determine if this is Xero or ApprovalMax based on tenant ID format
          const connectionStatus = await fetch("/api/connection-status").then(
            (r) => r.json()
          );
          const entityInfo = connectionStatus.find(
            (conn) => conn.tenantId === tenantId
          );

          if (!entityInfo) {
            throw new Error("Entity not found");
          }

          if (entityInfo.provider === "xero") {
            await loadXeroTenantData(tenantId);
          } else if (entityInfo.provider === "approvalmax") {
            await loadApprovalMaxTenantData(tenantId);
          }
        } catch (error) {
          console.error("Error loading tenant data:", error);
          showError("Failed to load entity data");
        }
      }

      // Load Xero tenant data
      async function loadXeroTenantData(tenantId) {
        const [
          cashResponse,
          receivablesResponse,
          invoicesResponse,
          contactsResponse,
        ] = await Promise.all([
          fetch(`/api/cash-position/${tenantId}`),
          fetch(`/api/receivables/${tenantId}`),
          fetch(`/api/outstanding-invoices/${tenantId}`),
          fetch(`/api/contacts/${tenantId}`),
        ]);

        const [cashData, receivablesData, invoicesData, contactsData] =
          await Promise.all([
            cashResponse.json(),
            receivablesResponse.json(),
            invoicesResponse.json(),
            contactsResponse.json(),
          ]);

        const tenantData = {
          provider: "xero",
          cash: cashData,
          receivables: receivablesData,
          invoices: invoicesData,
          contacts: contactsData,
        };

        dashboardData = tenantData;
        renderXeroTenantView(tenantData);
      }

      // Load ApprovalMax tenant data
      async function loadApprovalMaxTenantData(organizationId) {
        const [pendingResponse, summaryResponse, bottlenecksResponse] =
          await Promise.all([
            fetch(`/api/approvalmax/pending-approvals/${organizationId}`),
            fetch(`/api/approvalmax/approval-summary/${organizationId}`),
            fetch(`/api/approvalmax/workflow-bottlenecks/${organizationId}`),
          ]);

        const [pendingData, summaryData, bottlenecksData] = await Promise.all([
          pendingResponse.json(),
          summaryResponse.json(),
          bottlenecksResponse.json(),
        ]);

        const organizationData = {
          provider: "approvalmax",
          pending: pendingData,
          summary: summaryData,
          bottlenecks: bottlenecksData,
        };

        dashboardData = organizationData;
        renderApprovalMaxTenantView(organizationData);
      }

      // Show main dashboard
      function showDashboard() {
        document.getElementById("connection-manager").style.display = "none";
        document.getElementById("dashboard-controls").style.display = "block";
        document.getElementById("dashboard-content").style.display = "grid";
        loadDashboardData();
      }

      // Add these inside your existing <script> tag:

      // Global variable to track selected date
      let selectedReportDate = new Date().toISOString().split("T")[0];

      // Enhanced Dashboard Controls with Date Picker
      function updateDashboardControls() {
        const dashboardControlsHTML = `
    <div class="controls" id="dashboard-controls">
        <h3>üìä Trial Balance Controls</h3>
        <div class="subsidiary-selector">
            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                <!-- Date Picker Section -->
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="report-date" style="font-weight: bold; color: #13547a;">
                        üìÖ Report Date:
                    </label>
                    <input 
                        type="date" 
                        id="report-date" 
                        value="${selectedReportDate}"
                        onchange="updateReportDate(this.value)"
                        style="padding: 8px 12px; border: 2px solid #13547a; border-radius: 6px; font-size: 1rem; background: white; color: #333; cursor: pointer;"
                    />
                </div>

                <!-- Quick Date Buttons -->
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span style="font-size: 0.9rem; color: #666;">Quick:</span>
                    <button onclick="setQuickDate('today')" style="padding: 6px 12px; border: 1px solid #ccc; background: white; border-radius: 4px; font-size: 0.85rem; cursor: pointer;">Today</button>
                    <button onclick="setQuickDate('monthEnd')" style="padding: 6px 12px; border: 1px solid #ccc; background: white; border-radius: 4px; font-size: 0.85rem; cursor: pointer;">Month End</button>
                    <button onclick="setQuickDate('lastMonth')" style="padding: 6px 12px; border: 1px solid #ccc; background: white; border-radius: 4px; font-size: 0.85rem; cursor: pointer;">Last Month End</button>
                </div>

                <!-- Keep your existing entity selector and view toggle -->
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="subsidiary-select" style="font-weight: bold; color: #13547a;">üè¢ Entity:</label>
                    <select id="subsidiary-select" onchange="loadDashboardData()">
                        <option value="consolidated">üè¢ Consolidated View (All Entities)</option>
                    </select>
                </div>

                <div class="view-toggle">
                    <button class="toggle-btn active" onclick="setView('overview')">Overview</button>
                    <button class="toggle-btn" onclick="setView('detailed')">Detailed</button>
                    <button class="toggle-btn" onclick="toggleConnectionManager()">Connection Status</button>
                </div>
            </div>

            <!-- Date Information Display -->
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #13547a;">
                <div style="font-size: 0.9rem; color: #666;">
                    <span style="font-weight: bold;">Viewing:</span> 
                    Trial Balance as at <span style="font-weight: bold; color: #13547a;" id="display-date">${formatDisplayDate(
                      selectedReportDate
                    )}</span>
                </div>
            </div>
        </div>
    </div>
  `;

        const existingControls = document.getElementById("dashboard-controls");
        if (existingControls) {
          existingControls.outerHTML = dashboardControlsHTML;
        }
      }

      function updateReportDate(newDate) {
        selectedReportDate = newDate;
        document.getElementById("display-date").textContent =
          formatDisplayDate(newDate);
        loadDashboardData();
      }

      function setQuickDate(option) {
        let newDate;
        const today = new Date();

        switch (option) {
          case "today":
            newDate = today;
            break;
          case "monthEnd":
            newDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            break;
          case "lastMonth":
            newDate = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
          default:
            newDate = today;
        }

        const dateString = newDate.toISOString().split("T")[0];
        selectedReportDate = dateString;
        document.getElementById("report-date").value = dateString;
        document.getElementById("display-date").textContent =
          formatDisplayDate(dateString);
        loadDashboardData();
      }

      function formatDisplayDate(dateString) {
        const date = new Date(dateString + "T00:00:00");
        const options = {
          year: "numeric",
          month: "long",
          day: "numeric",
          weekday: "long",
        };
        return date.toLocaleDateString("en-AU", options);
      }

      // Call this when page loads
      document.addEventListener("DOMContentLoaded", function () {
        updateDashboardControls();
      });
      // ENHANCED HIERARCHICAL TRIAL BALANCE FRONTEND
      // Replace your renderTrialBalanceView function in index.html with this
      // Load and render hierarchical trial balance data
      async function loadTrialBalanceData() {
        try {
          const response = await fetch("/api/consolidated-trial-balance");
          const data = await response.json();

          dashboardData = data;
          renderHierarchicalTrialBalanceView(data);
        } catch (error) {
          console.error("Error loading hierarchical trial balance:", error);
          showError("Failed to load hierarchical trial balance data");
        }
      }

      // Render hierarchical trial balance view with expandable sections
      function renderHierarchicalTrialBalanceView(data) {
        document.querySelector(".toggle-btn").parentElement.style.display =
          "block";
        const content = document.getElementById("dashboard-content");

        const totals = data.consolidated.totals;
        const balanceCheck = data.consolidated.balanceCheck;
        const summary = data.summary;

        content.innerHTML = `
    <!-- Consolidated Trial Balance Overview - FULL WIDTH -->
    <div class="demo-card financial-overview">
        <div class="card-header">
            <h3>‚öñÔ∏è RAC Consolidated Trial Balance</h3>
            <p>Hierarchical financial position across ${
              data.companies.length
            } RAC entities</p>
        </div>
        <div class="card-content">
            <div class="dashboard-mockup">
                <!-- Consolidated Balance Check Status -->
                <div style="margin-bottom: 20px; padding: 15px; border-radius: 8px; ${
                  balanceCheck.debitsEqualCredits
                    ? "background: #d4edda; border: 1px solid #c3e6cb; color: #155724;"
                    : "background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24;"
                }">
                    <div style="font-weight: bold; margin-bottom: 5px;">
                        ${
                          balanceCheck.debitsEqualCredits
                            ? "‚úÖ Consolidated Books are BALANCED"
                            : "‚ö†Ô∏è Consolidated Books are OUT OF BALANCE"
                        }
                    </div>
                    <div style="font-size: 0.9rem;">
                        Debits: $${totals.totalDebits.toLocaleString()} | Credits: $${totals.totalCredits.toLocaleString()}
                        ${
                          !balanceCheck.debitsEqualCredits
                            ? ` | Difference: $${Math.abs(
                                balanceCheck.difference
                              ).toLocaleString()}`
                            : ""
                        }
                    </div>
                    <div style="font-size: 0.9rem; margin-top: 5px;">
                        Accounting Equation: Assets ($${totals.totalAssets.toLocaleString()}) = Liabilities + Equity ($${(
          totals.totalLiabilities + totals.totalEquity
        ).toLocaleString()})
                        ${
                          balanceCheck.accountingEquation.balanced
                            ? " ‚úÖ"
                            : " ‚ö†Ô∏è"
                        }
                    </div>
                </div>

                <!-- Consolidated Summary Totals -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px;">
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 1.4rem; font-weight: bold; color: #28a745;">$${totals.totalAssets.toLocaleString()}</div>
                        <div style="font-size: 1rem; color: #666;">Total Assets</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 1.4rem; font-weight: bold; color: #dc3545;">$${totals.totalLiabilities.toLocaleString()}</div>
                        <div style="font-size: 1rem; color: #666;">Total Liabilities</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 1.4rem; font-weight: bold; color: #17a2b8;">$${totals.totalEquity.toLocaleString()}</div>
                        <div style="font-size: 1rem; color: #666;">Total Equity</div>
                    </div>
                </div>

                <!-- Entity Breakdown Header -->
                <div style="border-bottom: 2px solid #13547a; padding-bottom: 10px; margin-bottom: 20px;">
                    <div style="font-weight: bold; font-size: 1.1rem; color: #13547a;">üìä Entity Breakdown:</div>
                    <div style="font-size: 0.9rem; color: #666;">
                        ${summary.totalCompanies} companies ‚Ä¢ ${
          summary.totalAccounts
        } accounts ‚Ä¢ 
                        ${summary.balancedCompanies}/${
          summary.totalCompanies
        } balanced
                    </div>
                </div>

                <!-- Company-by-Company Hierarchical Breakdown -->
                <div id="companies-breakdown">
                    ${data.companies
                      .map(
                        (company, companyIndex) => `
                        <div class="company-card" style="margin-bottom: 25px; border: 1px solid #ddd; border-radius: 10px; overflow: hidden;">
                            <!-- Company Header (Clickable to expand/collapse) -->
                            <div class="company-header" 
                                 onclick="toggleCompany(${companyIndex})" 
                                 style="
                                    background: ${
                                      company.balanceCheck.debitsEqualCredits
                                        ? "#f8f9fa"
                                        : "#fff3cd"
                                    }; 
                                    padding: 15px; 
                                    cursor: pointer; 
                                    border-bottom: 1px solid #ddd;
                                    display: flex; 
                                    justify-content: space-between; 
                                    align-items: center;
                                 ">
                                <div>
                                    <div style="font-weight: bold; color: #13547a; font-size: 1.1rem;">
                                        <span id="company-toggle-${companyIndex}" style="margin-right: 8px;">‚ñ∂</span>
                                        üè¢ ${company.tenantName}
                                    </div>
                                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                        ${
                                          company.accountCounts.totalAccounts
                                        } accounts ‚Ä¢ 
                                        ${
                                          company.balanceCheck
                                            .debitsEqualCredits
                                            ? "‚úÖ Balanced"
                                            : "‚ö†Ô∏è Out of Balance"
                                        }
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.9rem; color: #666;">Assets: $${company.totals.totalAssets.toLocaleString()}</div>
                                    <div style="font-size: 0.9rem; color: #666;">Liabilities: $${company.totals.totalLiabilities.toLocaleString()}</div>
                                    <div style="font-size: 0.9rem; color: #666;">Equity: $${company.totals.totalEquity.toLocaleString()}</div>
                                </div>
                            </div>

                            <!-- Company Sections (Initially Hidden) -->
                            <div id="company-sections-${companyIndex}" class="company-sections" style="display: none;">
                                ${Object.entries(company.sections)
                                  .filter(
                                    ([sectionKey, section]) =>
                                      section.accounts.length > 0
                                  )
                                  .map(
                                    ([sectionKey, section], sectionIndex) => `
                                    <div class="section-card" style="margin: 10px; border: 1px solid #e9ecef; border-radius: 8px;">
                                        <!-- Section Header (Clickable to expand/collapse accounts) -->
                                        <div class="section-header" 
                                             onclick="toggleSection(${companyIndex}, '${sectionKey}')"
                                             style="
                                                background: #f8f9fa; 
                                                padding: 12px; 
                                                cursor: pointer;
                                                display: flex; 
                                                justify-content: space-between; 
                                                align-items: center;
                                             ">
                                            <div>
                                                <span id="section-toggle-${companyIndex}-${sectionKey}" style="margin-right: 8px;">‚ñ∂</span>
                                                <strong>${
                                                  section.title
                                                }</strong>
                                                <span style="color: #666; margin-left: 10px;">(${
                                                  section.accounts.length
                                                } accounts)</span>
                                            </div>
                                            <div style="font-weight: bold; color: ${
                                              sectionKey === "assets"
                                                ? "#28a745"
                                                : sectionKey === "liabilities"
                                                ? "#dc3545"
                                                : sectionKey === "equity"
                                                ? "#17a2b8"
                                                : sectionKey === "revenue"
                                                ? "#28a745"
                                                : "#ffc107"
                                            };">
                                                $${section.total.toLocaleString()}
                                            </div>
                                        </div>

                                        <!-- Account Details (Initially Hidden) -->
                                        <div id="section-accounts-${companyIndex}-${sectionKey}" class="section-accounts" style="display: none;">
                                            <div style="padding: 10px;">
                                                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; background: #f1f3f4; padding: 8px; font-weight: bold; font-size: 0.9rem;">
                                                    <div>Account Name</div>
                                                    <div style="text-align: right;">Debit</div>
                                                    <div style="text-align: right;">Credit</div>
                                                </div>
                                                ${section.accounts
                                                  .map(
                                                    (account) => `
                                                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.9rem;">
                                                        <div>${
                                                          account.name
                                                        }</div>
                                                        <div style="text-align: right; ${
                                                          account.debit > 0
                                                            ? "font-weight: bold;"
                                                            : "color: #999;"
                                                        }">
                                                            ${
                                                              account.debit > 0
                                                                ? "$" +
                                                                  account.debit.toLocaleString()
                                                                : "-"
                                                            }
                                                        </div>
                                                        <div style="text-align: right; ${
                                                          account.credit > 0
                                                            ? "font-weight: bold;"
                                                            : "color: #999;"
                                                        }">
                                                            ${
                                                              account.credit > 0
                                                                ? "$" +
                                                                  account.credit.toLocaleString()
                                                                : "-"
                                                            }
                                                        </div>
                                                    </div>
                                                `
                                                  )
                                                  .join("")}
                                            </div>
                                        </div>
                                    </div>
                                `
                                  )
                                  .join("")}
                            </div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            </div>
            
            <div class="${
              balanceCheck.debitsEqualCredits ? "success-box" : "alert-box"
            }">
                ${
                  balanceCheck.debitsEqualCredits
                    ? "‚úÖ Consolidated Trial Balance is accurate across all RAC entities"
                    : "‚ö†Ô∏è Trial Balance shows discrepancies - expand companies above to review individual entity balances"
                }
            </div>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="demo-card">
        <div class="card-header">
            <h3>üìà Portfolio Overview</h3>
            <p>RAC financial portfolio at a glance</p>
        </div>
        <div class="card-content">
            <div class="dashboard-mockup">
                <div class="metric-row">
                    <span class="metric-label">Total Portfolio Value</span>
                    <span class="metric-value large">$${(
                      totals.totalAssets - totals.totalLiabilities
                    ).toLocaleString()}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Largest Entity</span>
                    <span class="metric-value">${
                      data.companies.length > 0
                        ? data.companies
                            .reduce((max, company) =>
                              company.totals.totalAssets >
                              max.totals.totalAssets
                                ? company
                                : max
                            )
                            .tenantName.split(" ")
                            .slice(0, 3)
                            .join(" ")
                        : "N/A"
                    }</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Data Quality</span>
                    <span class="metric-value" style="color: ${
                      summary.dataQuality.allBalanced ? "green" : "orange"
                    };">
                        ${
                          summary.dataQuality.allBalanced
                            ? "100% Balanced"
                            : "Review Required"
                        }
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Integration Status -->
    <div class="demo-card">
        <div class="card-header">
            <h3>üîó Integration Status</h3>
            <p>System connections and data flow</p>
        </div>
        <div class="card-content">
            <div class="dashboard-mockup">
                <div class="metric-row">
                    <span class="metric-label">Connected Entities</span>
                    <span class="metric-value">${
                      summary.totalCompanies
                    } RAC companies</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Total Accounts</span>
                    <span class="metric-value">${
                      summary.totalAccounts
                    } active accounts</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Last Update</span>
                    <span class="metric-value">Just now</span>
                </div>
            </div>
            <div class="success-box">
                ‚úÖ Hierarchical Trial Balance system operational - Real-time drilling from consolidated to account level
            </div>
        </div>
    </div>
  `;
      }

      // Toggle company expansion
      function toggleCompany(companyIndex) {
        const sectionsDiv = document.getElementById(
          `company-sections-${companyIndex}`
        );
        const toggleIcon = document.getElementById(
          `company-toggle-${companyIndex}`
        );

        if (sectionsDiv.style.display === "none") {
          sectionsDiv.style.display = "block";
          toggleIcon.textContent = "‚ñº";
        } else {
          sectionsDiv.style.display = "none";
          toggleIcon.textContent = "‚ñ∂";
        }
      }

      // Toggle section expansion
      function toggleSection(companyIndex, sectionKey) {
        const accountsDiv = document.getElementById(
          `section-accounts-${companyIndex}-${sectionKey}`
        );
        const toggleIcon = document.getElementById(
          `section-toggle-${companyIndex}-${sectionKey}`
        );

        if (accountsDiv.style.display === "none") {
          accountsDiv.style.display = "block";
          toggleIcon.textContent = "‚ñº";
        } else {
          accountsDiv.style.display = "none";
          toggleIcon.textContent = "‚ñ∂";
        }
      }

      // Show error message
      function showError(message) {
        const content = document.getElementById("dashboard-content");
        content.innerHTML = `<div class="error">‚ùå ${message}</div>`;
      }

      // Set view type
      function setView(viewType) {
        currentView = viewType;

        // Update button states
        document.querySelectorAll(".toggle-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        // Reload data with new view
        loadDashboardData();
      }

      // Event listeners
      document
        .getElementById("subsidiary-select")
        .addEventListener("change", loadDashboardData);

      // Auto-refresh data every 5 minutes
      setInterval(loadDashboardData, 300000);

      // Update timestamp
      function updateTimestamp() {
        document.getElementById("timestamp").textContent =
          new Date().toLocaleString();
      }

      // Initialize dashboard
      window.addEventListener("load", () => {
        updateTimestamp();
        setInterval(updateTimestamp, 30000);
        loadTenants();
      });
    </script>
  </body>
</html>
