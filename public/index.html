<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAC Live Financial Dashboard - Xero & ApprovalMax Integration</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        line-height: 1.6;
        color: #333;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
        padding: 40px 0;
      }

      .header h1 {
        font-size: 3rem;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .header p {
        font-size: 1.3rem;
        opacity: 0.9;
      }

      .live-indicator {
        display: inline-flex;
        align-items: center;
        background: rgba(76, 175, 80, 0.2);
        padding: 8px 16px;
        border-radius: 20px;
        margin-top: 15px;
        font-size: 0.9rem;
      }

      .live-dot {
        width: 8px;
        height: 8px;
        background: #4caf50;
        border-radius: 50%;
        margin-right: 8px;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .controls {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .controls h3 {
        color: #13547a;
        margin-bottom: 15px;
      }

      .subsidiary-selector {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .subsidiary-selector select {
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        background: white;
        cursor: pointer;
      }

      .view-toggle {
        display: flex;
        gap: 10px;
      }

      .toggle-btn {
        padding: 8px 16px;
        border: 2px solid #13547a;
        background: white;
        color: #13547a;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .toggle-btn.active {
        background: #13547a;
        color: white;
      }

      .connection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .entity-connection-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        border-left: 4px solid #e0e0e0;
        transition: all 0.3s ease;
      }

      .entity-connection-card.connected {
        border-left-color: #4caf50;
        background: #f1f8e9;
      }

      .entity-connection-card.disconnected {
        border-left-color: #ff9800;
        background: #fff3e0;
      }

      .entity-connection-card.xero {
        border-left-color: #13547a;
      }

      .entity-connection-card.approvalmax {
        border-left-color: #8e44ad;
      }

      .entity-name {
        font-weight: bold;
        color: #13547a;
        margin-bottom: 8px;
      }

      .provider-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: bold;
        margin-bottom: 8px;
      }

      .provider-badge.xero {
        background: #13547a;
        color: white;
      }

      .provider-badge.approvalmax {
        background: #8e44ad;
        color: white;
      }

      .connection-status {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      .status-indicator.connected {
        background: #4caf50;
      }

      .status-indicator.disconnected {
        background: #ff9800;
      }

      .connect-btn {
        background: #13547a;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.3s ease;
        margin-right: 5px;
      }

      .connect-btn:hover {
        background: #0f4059;
      }

      .connect-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .connect-btn.approvalmax {
        background: #8e44ad;
      }

      .connect-btn.approvalmax:hover {
        background: #7d3c98;
      }

      .connection-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .overlay-content {
        background: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 1000px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      .overlay-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
      }

      .close-btn {
        background: #ff5722;
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .close-btn:hover {
        background: #d84315;
      }

      .connection-status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
      }

      .connection-status-indicator.healthy {
        background: #e8f5e8;
        color: #2e7d32;
      }

      .connection-status-indicator.warning {
        background: #fff3e0;
        color: #f57c00;
      }

      .connection-status-indicator.error {
        background: #ffebee;
        color: #c62828;
      }

      .progress-bar {
        background: #e0e0e0;
        border-radius: 10px;
        height: 8px;
        margin: 15px 0;
        overflow: hidden;
      }

      .progress-fill {
        background: linear-gradient(45deg, #4caf50, #8bc34a);
        height: 100%;
        transition: width 0.3s ease;
      }

      .demo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 30px;
        margin-bottom: 40px;
      }

      .demo-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.3s ease;
      }

      .demo-card:hover {
        transform: translateY(-5px);
      }

      .card-header {
        background: linear-gradient(45deg, #13547a 0%, #80d0c7 100%);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .card-header.approvalmax {
        background: linear-gradient(45deg, #8e44ad 0%, #c39bd3 100%);
      }

      .card-header h3 {
        font-size: 1.5rem;
        margin-bottom: 5px;
      }

      .card-header p {
        opacity: 0.9;
        font-size: 0.9rem;
      }

      .card-content {
        padding: 25px;
      }

      .feature-list {
        list-style: none;
        margin-bottom: 20px;
      }

      .feature-list li {
        margin-bottom: 12px;
        padding-left: 25px;
        position: relative;
      }

      .feature-list li::before {
        content: "‚úì";
        position: absolute;
        left: 0;
        color: #4caf50;
        font-weight: bold;
        font-size: 1.2rem;
      }

      .dashboard-mockup {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 15px 0;
        border-left: 4px solid #13547a;
      }

      .dashboard-mockup.approvalmax {
        border-left-color: #8e44ad;
      }

      .metric-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
      }

      .metric-label {
        font-weight: 600;
        color: #666;
      }

      .metric-value {
        font-weight: bold;
        color: #13547a;
      }

      .metric-value.large {
        font-size: 1.2rem;
      }

      .metric-value.approvalmax {
        color: #8e44ad;
      }

      .chart-placeholder {
        height: 120px;
        background: linear-gradient(45deg, #e3f2fd 0%, #bbdefb 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 15px 0;
        color: #1976d2;
        font-weight: 600;
      }

      .alert-box {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 12px;
        margin: 10px 0;
        color: #856404;
      }

      .success-box {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 8px;
        padding: 12px;
        margin: 10px 0;
        color: #155724;
      }

      .info-box {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 8px;
        padding: 12px;
        margin: 10px 0;
        color: #0c5460;
      }

      .contacts-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin: 15px 0;
      }

      .contact-stat {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .contact-stat .number {
        font-size: 1.5rem;
        font-weight: bold;
        color: #13547a;
      }

      .contact-stat .label {
        font-size: 0.9rem;
        color: #666;
        margin-top: 5px;
      }

      .loading {
        color: #666;
        font-style: italic;
        text-align: center;
        padding: 20px;
      }

      .error {
        color: #dc3545;
        font-style: italic;
        text-align: center;
        padding: 20px;
      }

      .cta-section {
        background: white;
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        margin-top: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .cta-section h2 {
        color: #13547a;
        margin-bottom: 20px;
        font-size: 2rem;
      }

      .last-updated {
        font-size: 0.8rem;
        color: #888;
        text-align: center;
        margin-top: 15px;
        font-style: italic;
      }

      .system-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
      }

      .system-tab {
        padding: 10px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
      }

      .system-tab.active {
        color: #13547a;
        border-bottom-color: #13547a;
        font-weight: bold;
      }

      .system-tab.approvalmax.active {
        color: #8e44ad;
        border-bottom-color: #8e44ad;
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 2rem;
        }

        .demo-grid {
          grid-template-columns: 1fr;
        }

        .subsidiary-selector {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üè¢ RAC Financial Dashboard</h1>
        <p>Real-Time Xero & ApprovalMax Integration - Live Data</p>
        <div class="live-indicator">
          <div class="live-dot"></div>
          Connected to Xero & ApprovalMax ‚Ä¢ Live Data
        </div>
      </div>

      <!-- Connection Manager -->
      <div class="controls" id="connection-manager">
        <h3>üîó RAC Entity Connection Manager</h3>
        <div class="system-tabs">
          <button class="system-tab active" onclick="setSystemView('all')">
            All Systems
          </button>
          <button class="system-tab" onclick="setSystemView('xero')">
            Xero Only
          </button>
          <button
            class="system-tab approvalmax"
            onclick="setSystemView('approvalmax')"
          >
            ApprovalMax Only
          </button>
        </div>
        <div id="connection-status"></div>
      </div>

      <!-- Dashboard Controls -->
      <div class="controls" id="dashboard-controls" style="display: none">
        <h3>üìä Dashboard Controls</h3>
        <div class="subsidiary-selector">
          <label for="subsidiary-select"
            ><strong>Select RAC Entity:</strong></label
          >
          <select id="subsidiary-select">
            <option value="consolidated">
              üè¢ Consolidated View (All Entities)
            </option>
          </select>

          <div class="view-toggle">
            <button class="toggle-btn active" onclick="setView('overview')">
              Overview
            </button>
            <button class="toggle-btn" onclick="setView('detailed')">
              Detailed
            </button>
            <button class="toggle-btn" onclick="toggleConnectionManager()">
              Connection Status
            </button>
          </div>
        </div>
      </div>

      <!-- Connection Manager Overlay -->
      <div
        id="connection-overlay"
        class="connection-overlay"
        style="display: none"
      >
        <div class="overlay-content">
          <div class="overlay-header">
            <h3>üîó RAC Entity Connection Manager</h3>
            <button class="close-btn" onclick="closeConnectionManager()">
              ‚úï
            </button>
          </div>
          <div class="system-tabs">
            <button class="system-tab active" onclick="setSystemView('all')">
              All Systems
            </button>
            <button class="system-tab" onclick="setSystemView('xero')">
              Xero Only
            </button>
            <button
              class="system-tab approvalmax"
              onclick="setSystemView('approvalmax')"
            >
              ApprovalMax Only
            </button>
          </div>
          <div id="overlay-connection-status"></div>
        </div>
      </div>

      <div class="demo-grid" id="dashboard-content">
        <!-- Content will be loaded dynamically -->
        <div class="loading">Loading live RAC financial data...</div>
      </div>

      <div class="cta-section">
        <h2>üöÄ RAC Integrated Financial Dashboard!</h2>
        <p>
          Your Xero and ApprovalMax integrations are now live and pulling real
          financial data. All figures are updated in real-time from your RAC
          systems.
        </p>

        <div class="success-box" style="margin: 20px 0">
          <strong>Integration Achievements:</strong><br />
          ‚úÖ Xero OAuth authentication successful<br />
          ‚úÖ ApprovalMax OAuth authentication successful<br />
          ‚úÖ Live data connections established<br />
          ‚úÖ Financial & procurement metrics streaming in real-time<br />
          ‚úÖ Multi-entity support active<br />
          ‚úÖ Unified dashboard operational
        </div>

        <p style="margin-top: 20px; color: #666">
          Ready to extend this integration to your other RAC systems? Your
          Grants App, Inventory System, and Intranet are all ready to connect to
          this centralized financial intelligence platform.
        </p>
      </div>

      <div class="last-updated">
        Last updated: <span id="timestamp"></span> ‚Ä¢ Data sources: Live RAC Xero
        & ApprovalMax Accounts
      </div>
    </div>

    <script>
      let currentView = "overview";
      let currentSystemView = "all";
      let dashboardData = {};

      // Define all RAC entities
      const racEntities = [
        "Rirratjingu Aboriginal Corporation 8538",
        "Rirratjingu Mining Pty Ltd 7168",
        "Rirratjingu Property Management & Maintenance Services Pty Ltd",
        "Rirratjingu Enterprises Pty Ltd",
        "Rirratjingu Invest P/ L ATF Miliditjpi Trust",
        "Ngarrkuwuy Developments Pty Ltd",
        "Marrin Square Developments Pty Ltd",
      ];

      // Set system view (all, xero, approvalmax)
      function setSystemView(view) {
        currentSystemView = view;

        // Update tab states
        document.querySelectorAll(".system-tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.classList.add("active");

        // Reload connection status with filter
        loadConnectionStatus();
      }

      // Show connection manager
      function showConnectionManager(connectionData) {
        const connectionStatus = document.getElementById("connection-status");

        // Create comprehensive entity list for both systems
        const entityConnections = createEntityConnectionList(connectionData);

        // Filter based on current system view
        let filteredConnections = entityConnections;
        if (currentSystemView === "xero") {
          filteredConnections = entityConnections.filter(
            (conn) => conn.provider === "xero"
          );
        } else if (currentSystemView === "approvalmax") {
          filteredConnections = entityConnections.filter(
            (conn) => conn.provider === "approvalmax"
          );
        }

        const connectedCount = filteredConnections.filter(
          (conn) => conn.connected
        ).length;
        const totalCount = filteredConnections.length;
        const progressPercent =
          totalCount > 0 ? (connectedCount / totalCount) * 100 : 0;

        connectionStatus.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span><strong>Connection Progress:</strong></span>
                        <span><strong>${connectedCount} of ${totalCount} connections active</strong></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                </div>
                
                <div class="connection-grid">
                    ${filteredConnections
                      .map((conn) => {
                        return `
                            <div class="entity-connection-card ${
                              conn.connected ? "connected" : "disconnected"
                            } ${conn.provider}">
                                <div class="provider-badge ${
                                  conn.provider
                                }">${conn.provider.toUpperCase()}</div>
                                <div class="entity-name">${
                                  conn.tenantName
                                }</div>
                                <div class="connection-status">
                                    <div class="status-indicator ${
                                      conn.connected
                                        ? "connected"
                                        : "disconnected"
                                    }"></div>
                                    <span>${
                                      conn.connected
                                        ? "Connected & Active"
                                        : "Not Connected"
                                    }</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin: 5px 0;">
                                    ${
                                      conn.provider === "approvalmax" &&
                                      conn.organizationCount !== undefined
                                        ? `Organizations: ${conn.organizationCount} connected`
                                        : `Last seen: ${
                                            conn.lastSeen || "Never"
                                          }`
                                    }
                                </div>
                                ${
                                  !conn.connected
                                    ? `
                                    <button class="connect-btn ${
                                      conn.provider
                                    }" onclick="connectEntity('${
                                        conn.tenantName
                                      }', '${conn.provider}')">
                                        Connect ${
                                          conn.provider === "xero"
                                            ? "Xero"
                                            : "ApprovalMax"
                                        }
                                    </button>
                                `
                                    : `
                                    <div style="color: #4CAF50; font-size: 0.9rem; margin-top: 10px;">
                                        ‚úÖ Live data connection active
                                    </div>
                                    <button class="connect-btn ${conn.provider}" onclick="connectEntity('${conn.tenantName}', '${conn.provider}')" style="font-size: 0.8rem; padding: 6px 12px; margin-top: 5px;">
                                        Reconnect
                                    </button>
                                `
                                }
                            </div>
                        `;
                      })
                      .join("")}
                </div>
                
                ${
                  connectedCount > 0
                    ? `
                    <div class="success-box" style="margin-top: 20px;">
                        üéâ <strong>${connectedCount} connections active!</strong> Your dashboard is receiving live data.
                        <button class="connect-btn" onclick="showDashboard()" style="margin-left: 15px;">
                            ${
                              connectedCount === totalCount
                                ? "Launch Full Dashboard"
                                : "View Partial Dashboard"
                            }
                        </button>
                    </div>
                `
                    : `
                    <div class="info-box" style="margin-top: 20px;">
                        üí° <strong>Connect your systems:</strong> Set up Xero and ApprovalMax connections to enable consolidated financial reporting.
                    </div>
                `
                }
            `;
      }

      // Create comprehensive entity connection list for both systems
      function createEntityConnectionList(connectionData) {
        const entityConnections = [];

        // Add individual Xero connection entries for each RAC entity
        racEntities.forEach((entityName) => {
          const xeroConnection = connectionData.find(
            (conn) => conn.provider === "xero" && conn.tenantName === entityName
          );

          entityConnections.push({
            tenantId: xeroConnection ? xeroConnection.tenantId : null,
            tenantName: entityName,
            provider: "xero",
            connected: xeroConnection ? xeroConnection.connected : false,
            lastSeen: xeroConnection ? xeroConnection.lastSeen : null,
            error: xeroConnection ? xeroConnection.error : null,
          });
        });

        // Add single ApprovalMax connection entry for all organizations
        const approvalMaxConnections = connectionData.filter(
          (conn) => conn.provider === "approvalmax"
        );
        const hasApprovalMaxConnection = approvalMaxConnections.length > 0;
        const connectedOrgsCount = approvalMaxConnections.filter(
          (conn) => conn.connected
        ).length;

        entityConnections.push({
          tenantId: hasApprovalMaxConnection ? "approvalmax-integration" : null,
          tenantName: "RAC ApprovalMax Integration",
          provider: "approvalmax",
          connected: connectedOrgsCount > 0,
          lastSeen: hasApprovalMaxConnection
            ? approvalMaxConnections[0].lastSeen
            : null,
          error: hasApprovalMaxConnection
            ? approvalMaxConnections[0].error
            : null,
          organizationCount: connectedOrgsCount,
          totalOrganizations: approvalMaxConnections.length,
        });

        return entityConnections;
      }

      // Connect to specific entity
      function connectEntity(entityName, provider) {
        localStorage.setItem("connecting_entity", entityName);
        localStorage.setItem("connecting_provider", provider);

        if (provider === "approvalmax") {
          window.location.href = "/auth?provider=approvalmax";
        } else {
          window.location.href = "/auth";
        }
      }

      // Toggle connection manager overlay
      function toggleConnectionManager() {
        document.getElementById("connection-overlay").style.display = "flex";
        loadConnectionStatus();
      }

      // Close connection manager overlay
      function closeConnectionManager() {
        document.getElementById("connection-overlay").style.display = "none";
      }

      // Load connection status
      async function loadConnectionStatus() {
        try {
          const response = await fetch("/api/connection-status");
          const connectionStatus = await response.json();

          if (
            document.getElementById("connection-overlay").style.display ===
            "flex"
          ) {
            showOverlayConnectionManager(connectionStatus);
          } else {
            showConnectionManager(connectionStatus);
          }
        } catch (error) {
          console.error("Error loading connection status:", error);
          const targetElement =
            document.getElementById("connection-overlay").style.display ===
            "flex"
              ? document.getElementById("overlay-connection-status")
              : document.getElementById("connection-status");

          targetElement.innerHTML = `
                    <div class="error">‚ùå Failed to load connection status</div>
                `;
        }
      }

      // Show connection manager in overlay
      function showOverlayConnectionManager(connectionStatusArray) {
        const connectionStatus = document.getElementById(
          "overlay-connection-status"
        );

        // Create comprehensive entity list for both systems
        const entityConnections = createEntityConnectionList(
          connectionStatusArray
        );

        // Filter based on current system view
        let filteredConnections = entityConnections;
        if (currentSystemView === "xero") {
          filteredConnections = entityConnections.filter(
            (conn) => conn.provider === "xero"
          );
        } else if (currentSystemView === "approvalmax") {
          filteredConnections = entityConnections.filter(
            (conn) => conn.provider === "approvalmax"
          );
        }

        const connectedCount = filteredConnections.filter(
          (conn) => conn.connected
        ).length;
        const totalCount = filteredConnections.length;
        const progressPercent =
          totalCount > 0 ? (connectedCount / totalCount) * 100 : 0;

        const healthStatus = connectedCount > 0 ? "healthy" : "error";
        const healthText =
          connectedCount > 0 ? "Connections active" : "No connections";

        connectionStatus.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span><strong>RAC System Connections:</strong></span>
                        <div class="connection-status-indicator ${healthStatus}">
                            <div class="status-indicator ${healthStatus}"></div>
                            ${healthText}
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span><strong>Connection Progress:</strong></span>
                        <span><strong>${connectedCount} of ${totalCount} connections active</strong></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                </div>
                
                <div class="connection-grid">
                    ${filteredConnections
                      .map((conn) => {
                        const lastSeen = conn.lastSeen
                          ? new Date(conn.lastSeen).toLocaleString()
                          : "Never";

                        return `
                            <div class="entity-connection-card ${
                              conn.connected ? "connected" : "disconnected"
                            } ${conn.provider}">
                                <div class="provider-badge ${
                                  conn.provider
                                }">${conn.provider.toUpperCase()}</div>
                                <div class="entity-name">${
                                  conn.tenantName
                                }</div>
                                <div class="connection-status">
                                    <div class="status-indicator ${
                                      conn.connected
                                        ? "connected"
                                        : "disconnected"
                                    }"></div>
                                    <span>${
                                      conn.connected
                                        ? "Connected & Active"
                                        : "Not Connected"
                                    }</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin: 5px 0;">
                                    ${
                                      conn.provider === "approvalmax" &&
                                      conn.organizationCount !== undefined
                                        ? `Organizations: ${conn.organizationCount} connected`
                                        : `Last seen: ${lastSeen}`
                                    }
                                </div>
                                ${
                                  !conn.connected
                                    ? `
                                    <button class="connect-btn ${
                                      conn.provider
                                    }" onclick="connectEntity('${
                                        conn.tenantName
                                      }', '${conn.provider}')">
                                        Connect ${
                                          conn.provider === "xero"
                                            ? "Xero"
                                            : "ApprovalMax"
                                        }
                                    </button>
                                `
                                    : `
                                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                                        <button class="connect-btn ${conn.provider}" onclick="testConnection('${conn.tenantId}', '${conn.provider}')" style="font-size: 0.8rem; padding: 6px 12px;">
                                            Test Connection
                                        </button>
                                        <button class="connect-btn ${conn.provider}" onclick="connectEntity('${conn.tenantName}', '${conn.provider}')" style="opacity: 0.7; font-size: 0.8rem; padding: 6px 12px;">
                                            Reconnect
                                        </button>
                                    </div>
                                `
                                }
                            </div>
                        `;
                      })
                      .join("")}
                </div>
            `;
      }

      // Test connection for specific entity
      async function testConnection(tenantId, provider) {
        try {
          let response;
          if (provider === "xero") {
            response = await fetch(`/api/cash-position/${tenantId}`);
          } else if (provider === "approvalmax") {
            response = await fetch(
              `/api/approvalmax/approval-summary/${tenantId}`
            );
          }

          if (response.ok) {
            alert(
              `‚úÖ ${provider.toUpperCase()} connection is healthy and returning data`
            );
          } else {
            alert(
              `‚ö†Ô∏è ${provider.toUpperCase()} connection may have issues (${
                response.status
              })`
            );
          }
        } catch (error) {
          alert(
            `‚ùå ${provider.toUpperCase()} connection test failed: ${
              error.message
            }`
          );
        }
      }

      // Load available tenants and show appropriate interface
      async function loadTenants() {
        try {
          const response = await fetch("/api/connection-status");
          const connectionStatus = await response.json();

          // Show connection manager with all systems
          showConnectionManager(connectionStatus);

          // Populate dashboard selector with connected entities
          const connectedEntities = connectionStatus.filter(
            (entity) => entity.connected
          );
          if (connectedEntities.length > 0) {
            const select = document.getElementById("subsidiary-select");

            const consolidatedOption = select.querySelector(
              'option[value="consolidated"]'
            );
            select.innerHTML = "";
            select.appendChild(consolidatedOption);

            connectedEntities.forEach((entity) => {
              const option = document.createElement("option");
              option.value = entity.tenantId;
              option.textContent = `üè¢ ${
                entity.tenantName
              } (${entity.provider.toUpperCase()})`;
              select.appendChild(option);
            });
          }

          // Auto-launch dashboard if we have connections
          if (connectedEntities.length > 0) {
            setTimeout(() => showDashboard(), 2000);
          }
        } catch (error) {
          console.error("Error loading connection status:", error);
          document.getElementById("connection-status").innerHTML = `
                    <div class="error">‚ùå Failed to load connection status. 
                    <button class="connect-btn" onclick="window.location.href='/auth'">Connect to Xero</button>
                    <button class="connect-btn approvalmax" onclick="window.location.href='/auth?provider=approvalmax'">Connect to ApprovalMax</button></div>
                `;
        }
      }

      // Load dashboard data based on selected view
      async function loadDashboardData() {
        const selectedTenant =
          document.getElementById("subsidiary-select").value;

        try {
          if (selectedTenant === "consolidated") {
            await loadConsolidatedData();
          } else {
            await loadIndividualTenantData(selectedTenant);
          }
        } catch (error) {
          console.error("Error loading dashboard data:", error);
          showError("Failed to load financial data");
        }
      }

      // Load consolidated data across all RAC entities
      async function loadConsolidatedData() {
        try {
          const response = await fetch("/api/consolidated");
          const data = await response.json();

          dashboardData = data;
          renderConsolidatedView(data);
        } catch (error) {
          console.error("Error loading consolidated data:", error);
          showError("Failed to load consolidated data");
        }
      }

      // Load individual tenant data
      async function loadIndividualTenantData(tenantId) {
        try {
          // Determine if this is Xero or ApprovalMax based on tenant ID format
          const connectionStatus = await fetch("/api/connection-status").then(
            (r) => r.json()
          );
          const entityInfo = connectionStatus.find(
            (conn) => conn.tenantId === tenantId
          );

          if (!entityInfo) {
            throw new Error("Entity not found");
          }

          if (entityInfo.provider === "xero") {
            await loadXeroTenantData(tenantId);
          } else if (entityInfo.provider === "approvalmax") {
            await loadApprovalMaxTenantData(tenantId);
          }
        } catch (error) {
          console.error("Error loading tenant data:", error);
          showError("Failed to load entity data");
        }
      }

      // Load Xero tenant data
      async function loadXeroTenantData(tenantId) {
        const [
          cashResponse,
          receivablesResponse,
          invoicesResponse,
          contactsResponse,
        ] = await Promise.all([
          fetch(`/api/cash-position/${tenantId}`),
          fetch(`/api/receivables/${tenantId}`),
          fetch(`/api/outstanding-invoices/${tenantId}`),
          fetch(`/api/contacts/${tenantId}`),
        ]);

        const [cashData, receivablesData, invoicesData, contactsData] =
          await Promise.all([
            cashResponse.json(),
            receivablesResponse.json(),
            invoicesResponse.json(),
            contactsResponse.json(),
          ]);

        const tenantData = {
          provider: "xero",
          cash: cashData,
          receivables: receivablesData,
          invoices: invoicesData,
          contacts: contactsData,
        };

        dashboardData = tenantData;
        renderXeroTenantView(tenantData);
      }

      // Load ApprovalMax tenant data
      async function loadApprovalMaxTenantData(organizationId) {
        const [pendingResponse, summaryResponse, bottlenecksResponse] =
          await Promise.all([
            fetch(`/api/approvalmax/pending-approvals/${organizationId}`),
            fetch(`/api/approvalmax/approval-summary/${organizationId}`),
            fetch(`/api/approvalmax/workflow-bottlenecks/${organizationId}`),
          ]);

        const [pendingData, summaryData, bottlenecksData] = await Promise.all([
          pendingResponse.json(),
          summaryResponse.json(),
          bottlenecksResponse.json(),
        ]);

        const organizationData = {
          provider: "approvalmax",
          pending: pendingData,
          summary: summaryData,
          bottlenecks: bottlenecksData,
        };

        dashboardData = organizationData;
        renderApprovalMaxTenantView(organizationData);
      }

      // Show main dashboard
      function showDashboard() {
        document.getElementById("connection-manager").style.display = "none";
        document.getElementById("dashboard-controls").style.display = "block";
        document.getElementById("dashboard-content").style.display = "grid";
        loadDashboardData();
      }

      // Render consolidated view
      // Render consolidated view - MODIFIED Financial Overview Card
      function renderConsolidatedView(data) {
        document.querySelector(".toggle-btn").parentElement.style.display =
          "block";
        const content = document.getElementById("dashboard-content");

        const avgInvoiceValue =
          data.totalReceivables / Math.max(data.totalOutstandingInvoices, 1);
        const totalPortfolio = data.totalCash + data.totalReceivables;

        content.innerHTML = `
        <!-- Consolidated Financial Overview - MODIFIED WITH ACCOUNT LIST -->
        <div class="demo-card">
            <div class="card-header">
                <h3>üí∞ Financial Overview</h3>
                <p>Current RAC consolidated financial position</p>
            </div>
            <div class="card-content">
                <div class="dashboard-mockup">
                    <!-- Bank Accounts List with Scrolling -->
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold; margin-bottom: 8px; color: #13547a;">Bank Accounts:</div>
                        <div style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 5px; padding: 10px; background: #f9f9f9;">
                            ${
                              data.tenantData.length > 0 &&
                              data.tenantData[0] &&
                              data.tenantData[0].bankAccounts
                                ? data.tenantData[0].bankAccounts
                                    .map(
                                      (acc) => `
                                    <div style="display: flex; justify-content: space-between; padding: 2px 0; font-size: 0.9rem; border-bottom: 1px solid #f0f0f0;">
                                        <span style="color: #666;">${
                                          acc.name
                                        }</span>
                                        <span style="font-weight: bold; color: #13547a;">$${acc.balance.toLocaleString()}</span>
                                    </div>
                                `
                                    )
                                    .join("")
                                : '<div style="color: #999; font-style: italic;">No bank accounts loaded</div>'
                            }
                        </div>
                    </div>
                    
                    <!-- Summary Metrics -->
                    <div class="metric-row" style="border-top: 2px solid #13547a; padding-top: 10px; margin-top: 10px;">
                        <span class="metric-label">Total Cash Position</span>
                        <span class="metric-value large">${data.totalCash.toLocaleString()}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Outstanding Invoices</span>
                        <span class="metric-value large">${data.totalReceivables.toLocaleString()}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Invoice Count</span>
                        <span class="metric-value">${
                          data.totalOutstandingInvoices
                        } outstanding</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Average Invoice Value</span>
                        <span class="metric-value">${avgInvoiceValue.toLocaleString()}</span>
                    </div>
                </div>
                <div class="success-box">
                    ‚úÖ All figures shown in AUD from live Xero data across ${
                      data.tenantData.length
                    } RAC entities
                </div>
            </div>
        </div>

        <!-- Procurement & Approvals Overview -->
        <div class="demo-card">
            <div class="card-header approvalmax">
                <h3>üìã Procurement & Approvals</h3>
                <p>RAC approval workflow status and insights</p>
            </div>
            <div class="card-content">
                <div class="dashboard-mockup approvalmax">
                    <div class="metric-row">
                        <span class="metric-label">Pending Approvals</span>
                        <span class="metric-value large approvalmax">${
                          data.totalPendingApprovals || 0
                        }</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Total Approval Value</span>
                        <span class="metric-value large approvalmax">${(
                          data.totalApprovalValue || 0
                        ).toLocaleString()}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Connected Organizations</span>
                        <span class="metric-value approvalmax">${
                          data.approvalData ? data.approvalData.length : 0
                        } ApprovalMax orgs</span>
                    </div>
                </div>
                ${
                  data.totalPendingApprovals > 0
                    ? `
                    <div class="alert-box">
                        ‚ö†Ô∏è ${data.totalPendingApprovals} approvals pending - review workflow bottlenecks
                    </div>
                `
                    : `
                    <div class="success-box">
                        ‚úÖ No pending approvals - workflows running smoothly
                    </div>
                `
                }
            </div>
        </div>

        <!-- Cash Flow Intelligence -->
        <div class="demo-card">
            <div class="card-header">
                <h3>üìà Cash Flow Intelligence</h3>
                <p>RAC portfolio analysis and insights</p>
            </div>
            <div class="card-content">
                <div class="dashboard-mockup">
                    <p><strong>Portfolio Insights:</strong></p>
                    <div style="margin: 8px 0; font-size: 0.9rem;">
                        ‚Ä¢ Total portfolio value: ${totalPortfolio.toLocaleString()}
                    </div>
                    <div style="margin: 8px 0; font-size: 0.9rem;">
                        ‚Ä¢ Cash-to-receivables ratio: ${(
                          (data.totalCash /
                            Math.max(data.totalReceivables, 1)) *
                          100
                        ).toFixed(1)}%
                    </div>
                    <div style="margin: 8px 0; font-size: 0.9rem;">
                        ‚Ä¢ Average invoice value: ${avgInvoiceValue.toLocaleString()}
                    </div>
                    <div style="margin: 8px 0; font-size: 0.9rem;">
                        ‚Ä¢ Strongest performer: ${
                          data.tenantData.length > 0
                            ? data.tenantData.reduce((max, tenant) =>
                                tenant.cashPosition > max.cashPosition
                                  ? tenant
                                  : max
                              ).tenantName
                            : "N/A"
                        }
                    </div>
                </div>
                <div class="alert-box">
                    üí° ${
                      data.totalReceivables > data.totalCash
                        ? "Consider follow-up on high-value outstanding invoices"
                        : "Strong cash position - good liquidity"
                    }
                </div>
            </div>
        </div>

        <!-- Integration Status -->
        <div class="demo-card">
            <div class="card-header">
                <h3>üîó Integration Status</h3>
                <p>Connected RAC entities and system health</p>
            </div>
            <div class="card-content">
                <div class="dashboard-mockup">
                    <div class="metric-row">
                        <span class="metric-label">Xero Entities</span>
                        <span class="metric-value">${
                          data.tenantData.length
                        } connected</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">ApprovalMax Orgs</span>
                        <span class="metric-value">${
                          data.approvalData ? data.approvalData.length : 0
                        } connected</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Data Accuracy</span>
                        <span class="metric-value" style="color: green;">100% Live Data</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Last Sync</span>
                        <span class="metric-value">Just now</span>
                    </div>
                </div>
                <div class="success-box">
                    ‚úÖ Multi-system integration active - Xero financial data + ApprovalMax procurement workflows
                </div>
            </div>
        </div>
    `;
      }
      // Render Xero individual tenant view
      function renderXeroTenantView(data) {
        document.querySelector(".toggle-btn").parentElement.style.display =
          "none";
        const content = document.getElementById("dashboard-content");

        const outstandingAmount = data.invoices.reduce(
          (sum, inv) => sum + (inv.amountDue || 0),
          0
        );
        const customerCount = data.contacts.filter((c) => c.isCustomer).length;
        const supplierCount = data.contacts.filter((c) => c.isSupplier).length;
        const avgInvoiceValue =
          outstandingAmount / Math.max(data.invoices.length, 1);

        content.innerHTML = `
                <!-- Financial Overview -->
                <div class="demo-card">
                    <div class="card-header">
                        <h3>üí∞ Financial Overview</h3>
                        <p>Current entity financial position</p>
                    </div>
                    <div class="card-content">
                        <div class="dashboard-mockup">
                            <div class="metric-row">
                                <span class="metric-label">Outstanding Invoices</span>
                                <span class="metric-value large">${outstandingAmount.toLocaleString()}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Total Receivables</span>
                                <span class="metric-value large">${data.receivables.totalReceivables.toLocaleString()}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Total Cash</span>
                                <span class="metric-value large">${data.cash.totalCash.toLocaleString()}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Invoice Count</span>
                                <span class="metric-value">${
                                  data.invoices.length
                                } outstanding</span>
                            </div>
                        </div>
                        <div class="success-box">
                            ‚úÖ All figures shown in AUD from live Xero data
                        </div>
                    </div>
                </div>

                <!-- Contact Database -->
                <div class="demo-card">
                    <div class="card-header">
                        <h3>üë• Contact Database</h3>
                        <p>Entity customer and supplier network</p>
                    </div>
                    <div class="card-content">
                        <div class="contacts-summary">
                            <div class="contact-stat">
                                <div class="number">${
                                  data.contacts.length
                                }</div>
                                <div class="label">Total Contacts</div>
                            </div>
                            <div class="contact-stat">
                                <div class="number">${customerCount}</div>
                                <div class="label">Customers</div>
                            </div>
                            <div class="contact-stat">
                                <div class="number">${supplierCount}</div>
                                <div class="label">Suppliers</div>
                            </div>
                        </div>
                        <div class="info-box">
                            üìä Contact breakdown: ${(
                              (customerCount / data.contacts.length) *
                              100
                            ).toFixed(1)}% customers, ${(
          (supplierCount / data.contacts.length) *
          100
        ).toFixed(1)}% suppliers
                        </div>
                    </div>
                </div>

                <!-- Banking & Cash Flow -->
                <div class="demo-card">
                    <div class="card-header">
                        <h3>üè¶ Banking & Cash Flow</h3>
                        <p>Entity banking overview and cash management</p>
                    </div>
                    <div class="card-content">
                        <div class="dashboard-mockup">
                            <div class="metric-row">
                                <span class="metric-label">Total Cash Position</span>
                                <span class="metric-value large">${data.cash.totalCash.toLocaleString()}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Bank Accounts</span>
                                <span class="metric-value">${
                                  data.cash.bankAccounts.length
                                } active accounts</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Cash-to-Receivables Ratio</span>
                                <span class="metric-value">${(
                                  (data.cash.totalCash /
                                    Math.max(
                                      data.receivables.totalReceivables,
                                      1
                                    )) *
                                  100
                                ).toFixed(1)}%</span>
                            </div>
                        </div>
                        <div class="alert-box">
                            üí° ${
                              data.receivables.totalReceivables >
                              data.cash.totalCash
                                ? "Focus on collections to improve cash flow"
                                : "Strong cash position relative to receivables"
                            }
                        </div>
                    </div>
                </div>
            `;
      }

      // Render ApprovalMax individual tenant view
      function renderApprovalMaxTenantView(data) {
        document.querySelector(".toggle-btn").parentElement.style.display =
          "none";
        const content = document.getElementById("dashboard-content");

        content.innerHTML = `
                <!-- Approval Summary -->
                <div class="demo-card">
                    <div class="card-header approvalmax">
                        <h3>üìã Approval Summary</h3>
                        <p>Current organization approval status</p>
                    </div>
                    <div class="card-content">
                        <div class="dashboard-mockup approvalmax">
                            <div class="metric-row">
                                <span class="metric-label">Pending Approvals</span>
                                <span class="metric-value large approvalmax">${
                                  data.summary.pendingApprovals
                                }</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Total Documents</span>
                                <span class="metric-value approvalmax">${
                                  data.summary.totalDocuments
                                }</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Approved Today</span>
                                <span class="metric-value approvalmax">${
                                  data.summary.approvedToday
                                }</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Total Value</span>
                                <span class="metric-value large approvalmax">${data.summary.totalValue.toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="success-box">
                            ‚úÖ All data from live ApprovalMax workflows
                        </div>
                    </div>
                </div>

                <!-- Workflow Bottlenecks -->
                <div class="demo-card">
                    <div class="card-header approvalmax">
                        <h3>‚ö†Ô∏è Workflow Bottlenecks</h3>
                        <p>Approvers with pending documents</p>
                    </div>
                    <div class="card-content">
                        ${
                          data.bottlenecks && data.bottlenecks.length > 0
                            ? `
                            ${data.bottlenecks
                              .slice(0, 3)
                              .map(
                                (bottleneck) => `
                                <div class="dashboard-mockup approvalmax" style="margin-bottom: 15px;">
                                    <div class="metric-row">
                                        <span class="metric-label">Approver</span>
                                        <span class="metric-value approvalmax">${
                                          bottleneck.approver
                                        }</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">Pending Count</span>
                                        <span class="metric-value approvalmax">${
                                          bottleneck.pendingCount
                                        } documents</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">Total Value</span>
                                        <span class="metric-value approvalmax">${bottleneck.totalValue.toLocaleString()}</span>
                                    </div>
                                </div>
                            `
                              )
                              .join("")}
                        `
                            : `
                            <div class="success-box">
                                ‚úÖ No workflow bottlenecks detected
                            </div>
                        `
                        }
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="demo-card">
                    <div class="card-header approvalmax">
                        <h3>üìä Performance Metrics</h3>
                        <p>Approval workflow efficiency</p>
                    </div>
                    <div class="card-content">
                        <div class="dashboard-mockup approvalmax">
                            <div class="metric-row">
                                <span class="metric-label">Average Approval Time</span>
                                <span class="metric-value approvalmax">${
                                  data.summary.averageApprovalTime
                                } hours</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Rejected Documents</span>
                                <span class="metric-value approvalmax">${
                                  data.summary.rejectedCount
                                }</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Approval Rate</span>
                                <span class="metric-value approvalmax">${(
                                  ((data.summary.totalDocuments -
                                    data.summary.rejectedCount) /
                                    Math.max(data.summary.totalDocuments, 1)) *
                                  100
                                ).toFixed(1)}%</span>
                            </div>
                        </div>
                        <div class="info-box">
                            üìà Workflow insights: ${
                              data.summary.averageApprovalTime < 24
                                ? "Fast approval times"
                                : "Consider workflow optimization"
                            }
                        </div>
                    </div>
                </div>
            `;
      }

      // Show error message
      function showError(message) {
        const content = document.getElementById("dashboard-content");
        content.innerHTML = `<div class="error">‚ùå ${message}</div>`;
      }

      // Set view type
      function setView(viewType) {
        currentView = viewType;

        // Update button states
        document.querySelectorAll(".toggle-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");

        // Reload data with new view
        loadDashboardData();
      }

      // Event listeners
      document
        .getElementById("subsidiary-select")
        .addEventListener("change", loadDashboardData);

      // Auto-refresh data every 5 minutes
      setInterval(loadDashboardData, 300000);

      // Update timestamp
      function updateTimestamp() {
        document.getElementById("timestamp").textContent =
          new Date().toLocaleString();
      }

      // Initialize dashboard
      window.addEventListener("load", () => {
        updateTimestamp();
        setInterval(updateTimestamp, 30000);
        loadTenants();
      });
    </script>
  </body>
</html>
